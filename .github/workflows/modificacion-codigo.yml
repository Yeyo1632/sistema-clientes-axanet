name: ğŸ”„ ModificaciÃ³n de CÃ³digo - CI BÃ¡sico
description: Flujo automatizado que se activa con cambios en el cÃ³digo principal

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  deteccion-cambios:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Detectar cambios en el cÃ³digo
        run: |
          echo "ğŸ”„ [MODIFICACIÃ“N DE CÃ“DIGO DETECTADA]"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¢ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸŒ¿ Rama: ${{ github.ref }}"
          echo "ğŸ“ Mensaje del Commit:"
          echo "   '${{ github.event.head_commit.message }}'"
          echo "ğŸ“… Fecha: ${{ github.event.head_commit.timestamp }}"
          echo "ğŸ“Š Evento: ${{ github.event_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ‘¥ Notificar a equipos tÃ©cnicos
        run: |
          echo "ğŸ“¢ NOTIFICANDO A EQUIPOS TÃ‰CNICOS:"
          echo ""
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "â€¢ ğŸ‘¨â€ğŸ’» DevLead - @dev-lead-axanet (REVISIÃ“N REQUERIDA)"
            echo "â€¢ ğŸ–¥ï¸  ITTeam - @it-support-axanet (DESPLIEGUE POTENCIAL)"
            echo "â€¢ ğŸ‘¨â€ğŸ’» DevTeam - @dev-team-axanet (INFORMATIVO)"
            echo ""
            echo "ğŸ”” Cambios directos en rama ${{ github.ref }}"
            echo "ğŸ¯ AcciÃ³n: RevisiÃ³n y posible despliegue"
          else
            echo "â€¢ ğŸ‘¨â€ğŸ’» DevLead - @dev-lead-axanet (REVISIÃ“N PR)"
            echo "â€¢ ğŸ‘¨â€ğŸ’» DevTeam - @dev-team-axanet (REVISIÃ“N CÃ“DIGO)"
            echo ""
            echo "ğŸ”” Pull Request hacia ${{ github.ref }}"
            echo "ğŸ¯ AcciÃ³n: RevisiÃ³n de cÃ³digo requerida"
          fi

      - name: ğŸ› ï¸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ğŸ” AnÃ¡lisis de sintaxis Python
        run: |
          echo "ğŸ EJECUTANDO ANÃLISIS DE SINTÃXIS PYTHON"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Verificar sintaxis del archivo principal
          if python -m py_compile sistema_axanet.py; then
            echo "âœ… Sintaxis de sistema_axanet.py - VÃLIDA"
          else
            echo "âŒ Error de sintaxis en sistema_axanet.py"
            exit 1
          fi
          
          # Verificar que el archivo puede ser importado
          if python -c "import sistema_axanet; print('âœ… MÃ³dulo importado correctamente')"; then
            echo "âœ… ImportaciÃ³n del mÃ³dulo - EXITOSA"
          else
            echo "âŒ Error al importar el mÃ³dulo"
            exit 1
          fi
          
          # Verificar que la clase puede instanciarse
          if python -c "from sistema_axanet import SistemaClientesAxanet; print('âœ… Clase cargada correctamente')"; then
            echo "âœ… Clase principal - INSTANCIABLE"
          else
            echo "âŒ Error al cargar la clase principal"
            exit 1
          fi

      - name: ğŸ“Š AnÃ¡lisis de cambios en el cÃ³digo
        run: |
          echo "ğŸ“ˆ ANÃLISIS DE CAMBIOS REALIZADOS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Obtener archivos modificados
          echo "ğŸ“ Archivos modificados en este commit:"
          git diff --name-only HEAD~1 HEAD | while read file; do
            if [ -n "$file" ]; then
              echo "   â€¢ $file"
            fi
          done
          
          # Contar lÃ­neas modificadas
          ADDED=$(git diff --numstat HEAD~1 HEAD | awk '{sum += $1} END {print sum}')
          REMOVED=$(git diff --numstat HEAD~1 HEAD | awk '{sum += $2} END {print sum}')
          echo ""
          echo "ğŸ“Š EstadÃ­sticas de cambios:"
          echo "   ğŸ“¥ LÃ­neas aÃ±adidas: ${ADDED:-0}"
          echo "   ğŸ“¤ LÃ­neas eliminadas: ${REMOVED:-0}"
          
          # Verificar si hay cambios en dependencias
          if git diff --name-only HEAD~1 HEAD | grep -q "requirements.txt"; then
            echo "âš ï¸  Cambios detectados en dependencias"
          fi

      - name: ğŸ§ª Ejecutar pruebas bÃ¡sicas
        run: |
          echo "ğŸ§ª EJECUTANDO PRUEBAS BÃSICAS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Prueba 1: Verificar que el sistema inicia
          echo "ğŸ”§ Prueba 1 - InicializaciÃ³n del sistema..."
          if timeout 10s python -c "
from sistema_axanet import SistemaClientesAxanet
sistema = SistemaClientesAxanet('test_directorio')
print('âœ… Sistema inicializado correctamente')
print(f'ğŸ“ Directorio: {sistema.directorio}')
print(f'ğŸ‘¥ Clientes cargados: {len(sistema.clientes)}')
"; then
            echo "âœ… InicializaciÃ³n - EXITOSA"
          else
            echo "âš ï¸  InicializaciÃ³n - TIMEOUT (esperado para aplicaciones interactivas)"
          fi
          
          # Prueba 2: Verificar mÃ©todos principales
          echo ""
          echo "ğŸ”§ Prueba 2 - VerificaciÃ³n de mÃ©todos..."
          if python -c "
from sistema_axanet import SistemaClientesAxanet
sistema = SistemaClientesAxanet('test_directorio')
metodos = [method for method in dir(sistema) if not method.startswith('_')]
metodos_esperados = ['crear_nuevo_cliente', 'visualizar_cliente', 'agregar_servicio', 'eliminar_cliente']
for metodo in metodos_esperados:
    if metodo in metodos:
        print(f'âœ… MÃ©todo {metodo} - PRESENTE')
    else:
        print(f'âŒ MÃ©todo {metodo} - NO ENCONTRADO')
"; then
            echo "âœ… VerificaciÃ³n de mÃ©todos - COMPLETADA"
          else
            echo "âŒ Error en verificaciÃ³n de mÃ©todos"
          fi

      - name: ğŸ“ Generar reporte de calidad
        run: |
          echo "ğŸ“‹ REPORTE DE CALIDAD DEL CÃ“DIGO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # AnÃ¡lisis bÃ¡sico de estructura
          echo "ğŸ” AnÃ¡lisis de estructura del cÃ³digo:"
          TOTAL_LINEAS=$(wc -l < sistema_axanet.py 2>/dev/null || echo "0")
          TOTAL_CLASES=$(grep -c "^class " sistema_axanet.py 2>/dev/null || echo "0")
          TOTAL_FUNCIONES=$(grep -c "^def " sistema_axanet.py 2>/dev/null || echo "0")
          
          echo "   ğŸ“„ Total de lÃ­neas: $TOTAL_LINEAS"
          echo "   ğŸ—ï¸  Total de clases: $TOTAL_CLASES"
          echo "   âš™ï¸  Total de funciones: $TOTAL_FUNCIONES"
          
          # Verificar presencia de documentaciÃ³n bÃ¡sica
          if grep -q '""".*"""' sistema_axanet.py || grep -q "'''.*'''" sistema_axanet.py; then
            echo "   ğŸ“š DocumentaciÃ³n - DETECTADA"
          else
            echo "   âš ï¸  DocumentaciÃ³n - RECOMENDADA"
          fi
          
          echo ""
          echo "ğŸ¯ RECOMENDACIONES:"
          echo "   â€¢ Revisar cambios antes de despliegue"
          echo "   â€¢ Ejecutar pruebas manuales en entorno de staging"
          echo "   â€¢ Verificar compatibilidad con sistemas existentes"

      - name: ğŸš€ Preparar para despliegue
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        run: |
          echo "ğŸš€ PREPARANDO PARA POSIBLE DESPLIEGUE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "ğŸ“¦ Empaquetando aplicaciÃ³n..."
          echo "âœ… CÃ³digo validado y empaquetado"
          echo ""
          echo "ğŸ¯ PrÃ³ximos pasos requeridos:"
          echo "   1. ğŸ‘¨â€ğŸ’» DevLead - Aprobar despliegue"
          echo "   2. ğŸ–¥ï¸  ITTeam - Programar ventana de despliegue"
          echo "   3. ğŸ‘¨â€ğŸ’» DevTeam - Preparar notas de release"
          echo "   4. ğŸ’¼ CustServTeam - Notificar a usuarios"
          
          # Generar artefacto simple
          tar czf sistema-axanet-$(date +%Y%m%d-%H%M%S).tar.gz sistema_axanet.py README.md
          echo "ğŸ“ Artefacto generado: sistema-axanet-*.tar.gz"

      - name: âœ… Resumen final
        run: |
          echo "âœ… PROCESO DE VALIDACIÃ“N COMPLETADO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ El cÃ³digo ha pasado todas las validaciones bÃ¡sicas"
          echo ""
          echo "ğŸ“‹ RESUMEN:"
          echo "   â€¢ ğŸ” Sintaxis Python - âœ… VÃLIDA"
          echo "   â€¢ ğŸ§ª Pruebas bÃ¡sicas - âœ… EXITOSAS" 
          echo "   â€¢ ğŸ“Š AnÃ¡lisis estÃ¡tico - âœ… COMPLETADO"
          echo "   â€¢ ğŸš€ PreparaciÃ³n despliegue - âœ… LISTO"
          echo ""
          echo "ğŸ‘¥ Equipos notificados:"
          echo "   â€¢ DevLead - Para revisiÃ³n final"
          echo "   â€¢ ITTeam - Para posible despliegue"
          echo "   â€¢ DevTeam - Para informaciÃ³n"
          echo ""
          echo "ğŸ”” Estado: LISTO PARA PRÃ“XIMOS PASOS"
